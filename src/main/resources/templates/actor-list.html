<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="ISO-8859-1">
    <title>Actor List</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
          integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #f8f9fa;
        }
        label.error {
            font-size:15px;
            color: red;
            padding: 2px 8px;
            margin-top: 2px;
	 }
    </style>
</head>
<body>
<section class="middle search">
    <div class="container" id="actorContainer">
        <div class="row justify-content-center">
            <div class="card">
                <div class="card-header">Actor List</div>
                <div class="card-body">
                    <div th:switch="${actors}" class="container my-5">
                        <div class="row">
                            <div class="col">
                                <!-- Button trigger modal -->
                                <button class="btn btn-primary btn-block mb-3" data-toggle="modal" data-target="#myModal">Add Actor</button>
                            </div>
                            <div class="col">
                                <a th:href="@{/movies}"><button class="btn btn-primary btn-block mb-3">Show Movies</button></a>
                            </div>
                        </div>

                        <div class="table-responsive">
                            <table id="userTable" class="table table-bordered">
                                <thead>
                                <tr>
                                    <th>Actor ID</th>
                                    <th>Actor Name</th>
                                    <th>Gender</th>
                                    <th>Date Of Birth</th>
                                    <th>Phone</th>
                                    <th>Biography</th>
                                    <th>Actions</th>
                                </tr>
                                </thead>
                                <tbody id="actor-data">
                                <h2 id="actor-count"></h2>
                                <!--<h2 th:case="null">No Actors yet!</h2>
                                <div th:case="*">
                                    <tr th:each="actor : ${actors}" th:id="'usergrid-tr-id_'+${actor.id}">
                                        <td th:text="${actor.id}"></td>
                                        <td th:text="${actor.userName}"></td>
                                        <td th:text="${actor.gender}"></td>
                                        <td th:text="${actor.dateOfBirth}"></td>
                                        <td th:text="${actor.phoneNumber}"></td>
                                        <td th:text="${actor.biography}"></td>
                                        <td>
                                            <a th:href="@{/actor/edit/{id}(id=${actor.id})}">Edit</a>
                                            <a th:href="@{/actor/delete/{id}(id=${actor.id})}" onclick="return confirm('Are you sure you want to delete this Actor?')">Delete</a>
                                        </td>
                                    </tr>
                                </div>
                                --><!-- Additional rows can be added dynamically -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.0/jquery.validate.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery-validation@1.19.5/dist/jquery.validate.js"></script>
<script src="https://ajax.aspnetcdn.com/ajax/jquery.validate/1.11.0/additional-methods.js"></script>
<script type="text/javascript" src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>


<!-- Modal -->
<div class="modal fade" id="myModal" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">

            <!-- Modal header -->
            <div class="modal-header">
                <h4 class="modal-title">Add Actor</h4>
                <span style="color:red" th:text="${error}"></span>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>

            <!-- Modal body -->
            <div class="modal-body">


                <form id="registrationForm" autocomplete="off">
                    <input type="number" id="id" hidden="hidden" />
                    <div class="form-group">
                        <label class="control-label" for="userName">Username</label>
                        <input type="text" class="form-control" id="userName" name="userName"
                               placeholder="Enter username">
                    </div>

                    <div class="form-group">
                        <label class="control-label">Gender</label>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="gender" value="Male"
                                   id="genderMale">
                            <label class="form-check-label" for="genderMale">Male</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="gender"
                                   id="genderFemale" value="Female">
                            <label class="form-check-label" for="genderFemale">Female</label>
                        </div>
                        <div id="genderError" class="gender-error"></div>
                    </div>

                    <div class="form-group">
                        <label class="control-label" for="dateOfBirth">Date of Birth</label>
                        <input type="date" class="form-control" id="dateOfBirth"
                               name="dateOfBirth" autocomplete="off">
                    </div>

                    <div class="form-group">
                        <label class="control-label" for="phoneNumber">Phone Number</label>
                        <input type="tel" class="form-control" id="phoneNumber"
                               name="phoneNumber">
                    </div>

                    <div class="form-group">
                        <label class="control-label" for="biography">biography</label>
                        <textarea class="form-control" id="biography" name="biography"
                                  rows="3"></textarea>
                    </div>


                    <!-- Modal footer -->
                    <div class="modal-footer">
                        <button type="button" class="btn btn-success" data-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" onclick="addActorHandler(event)">Submit</button>
                    </div>
                </form>
             </div>
        </div>
    </div>
</div>
<script th:src="@{/js/app.js}"></script>
<script>
    var actors;

       $.ajax({
           method: 'GET',
           url: '/api/v1/actors',
           success: function (response) {
               actors = response.data;
               console.log(response)
               populateActorsAtDom(response)
           }
       })

       function populateActorsAtDom(actors = []) {
           const actorElementCountTag = document.getElementById("actor-count");
           actorElementCountTag.innerHTML = actors ? 'Total Actors: ' + actors.length : "No Actors Yet!";

           const actorElementDataDivTag = document.getElementById("actor-data")

           actors.forEach(({biography, dateOfBirth, gender, id, phoneNumber, userName}) => {
               actorElementDataDivTag.innerHTML+=`
                   <tr>
                       <td >${id}</td>
                       <td >${userName}</td>
                       <td >${gender}</td>
                       <td >${dateOfBirth}</td>
                       <td >${phoneNumber}</td>
                       <td >${biography}</td>
                       <td>
                           <button data-toggle="modal" data-target="#myModal" onclick="openSuccessResponseForm(${id})">Edit</button>
                           <button onclick="deleteActorById(${id})">Delete</button>
                       </td>
                   </tr>
                   `;
           })
       }

       function addActorHandler(event) {
           event.preventDefault();
           var IsValid = $("#registrationForm").valid();
           var selected = $("input[type='radio'][name='gender']:checked");

           if(IsValid)
           {
               var ajaxResponse;
               var actor = {
                   id: document.getElementById("id").value,
                   userName: document.getElementById("userName").value,
                   gender: selected.length > 0 ? selected.val() : 0,
                   dateOfBirth: document.getElementById("dateOfBirth").value,
                   phoneNumber: document.getElementById("phoneNumber").value,
                   biography: document.getElementById("biography").value,
               };

               if (actor.id === "") {
                  $.ajax({
                      async: false,
                      type: "POST",
                      contentType: "application/json",
                      dataType: "json",
                      url: "api/v1/actors",
                      data: JSON.stringify(actor),
                      success: (successResponse) => {
                          ajaxResponse = successResponse;
                          window.location.reload();
                      },
                      error: (errorResponse) => {
                          console.log(errorResponse.responseText);
                      },
                  });
              } else {
                  $.ajax({
                      async: false,
                      type: "PUT",
                      contentType: "application/json",
                      dataType: "json",
                      url: "/api/v1/actors/" + actor.id,
                      data: JSON.stringify(actor),
                      success: ({resultStatus}) => {

                          console.log(resultStatus);
                      },
                      error: (errorResponse) => {
                          console.log(errorResponse.responseText);
                      },
                  });
              }
           }
       }

        function openSuccessResponseForm(id)
        {
            $.ajax
            ({
                async: false,
                type: "GET",
                contentType: "application/json",
                dataType: "json",
                url: "/api/v1/actors/" + id,
                success: (successResponse) =>
                {

                        $('#id').val(successResponse.id);
                        $('#userName').val(successResponse.userName);
                        $('#gender').val(successResponse.gender);
                        $('#dateOfBirth').val(successResponse.dateOfBirth);
                        $('#phoneNumber').val(successResponse.phoneNumber);
                        $('#biography').val(successResponse.biography);

                    console.log("ej");
                },
                error: (errorResponse) => {
                    console.log("something bad happended!");
                },
            });
        }

    function deleteActorById(id) {
        $.ajax({
                async: false,
                type: "DELETE",
                contentType: "application/json",
                dataType: "json",
                url: "/api/v1/actors/" + id,
                success: ({resultStatus}) => {
                    console.log(resultStatus)
                    if (resultStatus.status === "SUCCESS") {
                        removeActorFromDom(id);
                        alert("Actor deleted successfully")
                        window.location.reload();
                    } else {
                        alert(resultStatus.errorMessage);
                    }
                },
                error: (errorResponse) => {
                    alert("something bad happended!");
                },
        })
    }

    function removeActorFromDom(id) {
        const actorToRemove = document.getElementById("actor_id_" + id);
        console.log(actorToRemove)
        if (actorToRemove != null) {
            actorToRemove.remove();
        }
    }
</script>
</body>
</html>